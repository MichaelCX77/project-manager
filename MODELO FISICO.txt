DROP DATABASE PM_PRD;
CREATE DATABASE PM_PRD;
USE PM_PRD;

#############TABELAS DE DESCRICAO#############

CREATE TABLE STATUS_TAREFA_DESC(
STATUS_ID INT (1) PRIMARY KEY,
STATUS_DESC NVARCHAR (20) NOT NULL
);

CREATE TABLE COD_TIPO_DESC (
COD_TIPO_SIGLA CHAR (1) PRIMARY KEY,
COD_TIPO_DESC NVARCHAR (20) NOT NULL
) engine = 'InnoDB';

CREATE TABLE AVALIACAO_DESC (
AVAL_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
AVAL_TIPO NVARCHAR (2) NOT NULL UNIQUE,
AVAL_DESC NVARCHAR (25) NOT NULL
) engine = 'InnoDB';

CREATE TABLE LIB_SIGLAS_DESC (
LIB_ID INT (10) PRIMARY KEY,
LIB_TIPO CHAR NOT NULL UNIQUE,
LIB_DESC NVARCHAR (20)
) engine = 'InnoDB';

CREATE TABLE PERFIL_DESC (
PERFIL_ID INT (10) PRIMARY KEY,
PERFIL_NOME NVARCHAR (20) NOT NULL UNIQUE,
PERFIL_DESC NVARCHAR (5000) NOT NULL
) engine = 'InnoDB';

#############ENTIDADES PRINCIPAIS#############

CREATE TABLE UNIDADE_APLIC (
UNI_APLIC_ID INT(10) PRIMARY KEY AUTO_INCREMENT,
UNI_NOME NVARCHAR (40) NOT NULL UNIQUE,
UNI_CEP INT (8) NOT NULL,
UNI_PAIS NVARCHAR (25) NOT NULL,
UNI_ESTADO NVARCHAR (25) NOT NULL,
UNI_CIDADE NVARCHAR (25) NOT NULL,
UNI_ENDERECO NVARCHAR (50) NOT NULL UNIQUE,
UNI_NUM INT (5) NOT NULL
) engine = 'InnoDB';

CREATE TABLE ESCOLA_APLIC (
ESC_APLIC_ID INT(10) PRIMARY KEY AUTO_INCREMENT,
ESC_NOME NVARCHAR (50) NOT NULL UNIQUE,
ESC_CNPJ NVARCHAR (14) NOT NULL UNIQUE,
DIR_FUND_NOME NVARCHAR (35) NOT NULL UNIQUE,
DIR_FUND_EMAIL NVARCHAR (25) NOT NULL,
DIR_FUND_TELEFONE INT (13) NOT NULL,
DIR_FUND_CPF NVARCHAR (11) NOT NULL UNIQUE,
DIR_FUND_DT_NASC DATE NOT NULL
) engine = 'InnoDB';

CREATE TABLE CURSO_APLIC (
CUR_APLIC_ID INT(10) PRIMARY KEY AUTO_INCREMENT,
CUR_COD NVARCHAR(10) NOT NULL,
CUR_NOME NVARCHAR (40) NOT NULL,
CUR_CORD NVARCHAR (30) NOT NULL
) engine = 'InnoDB';

CREATE TABLE DISCIPLINA_APLIC (
DISC_APLIC_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
DISC_NOME NVARCHAR (40) NOT NULL,
DISC_DESCRICAO NVARCHAR (250)
) engine = 'InnoDB';

CREATE TABLE CLASSE_APLIC (
CLAS_APLIC_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
CLAS_NOME NVARCHAR (30) NOT NULL,
CLAS_COD NVARCHAR (10) NOT NULL,
CLAS_DATA_CRIACAO DATE NOT NULL,
CLAS_PERIODO INT (1) NOT NULL,
CLAS_SEMESTRE INT (1) NOT NULL,
CLAS_ANO INT (4) NOT NULL
) engine = 'InnoDB';


CREATE TABLE USUARIO_APLIC (
USU_APLIC_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
USU_NOME NVARCHAR (50) NOT NULL,
USU_EMAIL NVARCHAR (55) NOT NULL UNIQUE,
USU_NASC DATE NOT NULL,
USU_TIPO CHAR NOT NULL,
USU_REGISTRO NVARCHAR (10) NOT NULL,
USU_CPF NVARCHAR (11) NOT NULL UNIQUE,
USU_SENHA NVARCHAR (21) NOT NULL,
USU_ATIVO CHAR NOT NULL,
USU_CRIACAO DATETIME NOT NULL,
USU_ULTIMO_ACESSO DATETIME,
USU_TENTATIVAS INT (1) NOT NULL
) engine = 'InnoDB';

CREATE TABLE TRABALHO_APLIC (
TRAB_APLIC_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
TRAB_NOME NVARCHAR (30) NOT NULL,
TRAB_PROFESSOR INT (10) NOT NULL,
TRAB_DESCRICAO NVARCHAR (350),
TRAB_CRIACAO DATE NOT NULL,
TRAB_ENTREGA DATE NOT NULL,
FOREIGN KEY (TRAB_PROFESSOR) REFERENCES USUARIO_APLIC(USU_APLIC_ID)
) engine = 'InnoDB';

CREATE TABLE GRUPO_APLIC (
GRUPO_APLIC_ID INTEGER (10) PRIMARY KEY AUTO_INCREMENT,
GRUPO_NOME NVARCHAR (20) NOT NULL,
GRUPO_USU_ID int (10),
GRUPO_USU_LIDER char,
FOREIGN KEY (GRUPO_USU_ID) REFERENCES USUARIO_APLIC(USU_APLIC_ID)
) engine = 'InnoDB';

CREATE TABLE TAREFA_APLIC (
TAR_APLIC_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
TAR_NOME NVARCHAR (50) NOT NULL,
TAR_DESC NVARCHAR (250) NOT NULL,
TAR_RESP_ID INT (10) NOT NULL,
TAR_USU_CRIADOR INT (10) NOT NULL,
TAR_INI DATE,
TAR_FIM TIMESTAMP NOT NULL,
TAR_STATUS INT (1) NOT NULL,
FOREIGN KEY (TAR_RESP_ID) REFERENCES USUARIO_APLIC(USU_APLIC_ID),
FOREIGN KEY (TAR_USU_CRIADOR) REFERENCES USUARIO_APLIC(USU_APLIC_ID),
FOREIGN KEY (TAR_STATUS) REFERENCES STATUS_TAREFA_DESC(STATUS_ID)
) engine = 'InnoDB';

CREATE TABLE CODIGOS_APLIC (
CODIGOS_APLIC_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
USU_ID INT (10) ,
COD_TIPO_DESC CHAR (1) NOT NULL,
CODIGO NVARCHAR (10) NOT NULL,
DT_GERACAO DATE NOT NULL,
ATIVO CHAR NOT NULL,
FOREIGN KEY (COD_TIPO_DESC) REFERENCES COD_TIPO_DESC(COD_TIPO_SIGLA)
) engine = 'InnoDB';

CREATE TABLE LIBERA_APLIC (
LIBERA_APLIC_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
ESC_ID INT (10) NOT NULL,
LIB_CPF NVARCHAR (11) NOT NULL,
LIB_TIPO CHAR,
CODIGOS_ID INT (10) NOT NULL,
FOREIGN KEY (ESC_ID) REFERENCES ESCOLA_APLIC(ESC_APLIC_ID),
FOREIGN KEY (LIB_CPF) REFERENCES USUARIO_APLIC(USU_CPF),
FOREIGN KEY (LIB_TIPO) REFERENCES LIB_SIGLAS_DESC(LIB_TIPO),
FOREIGN KEY (CODIGOS_ID) REFERENCES CODIGOS_APLIC(CODIGOS_APLIC_ID)
) engine = 'InnoDB';

#############TABELAS DE RELACIONAMENTO#############

INSERT INTO ESCOLA_APLIC (ESC_NOME,ESC_CNPJ,DIR_FUND_NOME,DIR_FUND_EMAIL,DIR_FUND_TELEFONE,DIR_FUND_CPF,DIR_FUND_DT_NASC) VALUES ('ESCOLA TESTE','00000000000000','DIRETOR FUNDADOR TESTE','DIRETOR FUNDADOR EMAIL','0000000000','00000000000','19/02/20 00:00:00');

CREATE TABLE RELACAO_CLASSE (
RELACAO_CLASSE_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
ESC_ID INT (10) NOT NULL,
UNI_ID INT (10),
CUR_ID INT (10),
DISC_ID INT (10),
CLAS_ID INT (10),
DT_REGISTRO TIMESTAMP,
FOREIGN KEY (ESC_ID) REFERENCES ESCOLA_APLIC(ESC_APLIC_ID),
FOREIGN KEY (UNI_ID) REFERENCES UNIDADE_APLIC(UNI_APLIC_ID),
FOREIGN KEY (CUR_ID) REFERENCES CURSO_APLIC(CUR_APLIC_ID),
FOREIGN KEY (DISC_ID) REFERENCES DISCIPLINA_APLIC(DISC_APLIC_ID),
FOREIGN KEY (CLAS_ID) REFERENCES CLASSE_APLIC(CLAS_APLIC_ID)
) engine = 'InnoDB';

CREATE TABLE RELACAO_ACESSO (
RELACAO_ACESSO_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
CLAS_ID INT (10) NOT NULL,
USU_SOLICT_ID int (10) NOT NULL,
USU_ID INT (10) NOT NULL,
ACES CHAR (1) NOT NULL,
DT_REGISTRO DATE NOT NULL,
DT_VENCIMENTO DATE,
FOREIGN KEY (CLAS_ID) REFERENCES CLASSE_APLIC(CLAS_APLIC_ID),
FOREIGN KEY (USU_ID) REFERENCES USUARIO_APLIC(USU_APLIC_ID),
FOREIGN KEY (USU_SOLICT_ID) REFERENCES USUARIO_APLIC(USU_APLIC_ID)
) engine = 'InnoDB';

CREATE TABLE RELACAO_TRAB (
RELACAO_TRAB_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
CLAS_ID INT (10) NOT NULL,
TRAB_ID INT (10) NOT NULL,
GRUPO_ID INT (10),
TAR_ID INT (10),
FOREIGN KEY (CLAS_ID) REFERENCES CLASSE_APLIC(CLAS_APLIC_ID),
FOREIGN KEY (TRAB_ID) REFERENCES TRABALHO_APLIC(TRAB_APLIC_ID),
FOREIGN KEY (GRUPO_ID) REFERENCES GRUPO_APLIC(GRUPO_APLIC_ID),
FOREIGN KEY (TAR_ID) REFERENCES TAREFA_APLIC(TAR_APLIC_ID)
) engine = 'InnoDB';

CREATE TABLE RELACAO_NOTAS (
RELACAO_NOTAS_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
GRUPO_ID INT (10) NOT NULL,
USU_ID INT (10) NOT NULL,
NOTA FLOAT (2,1),
PONTUACAO INT (1),
AVAL_POS_ID INT (1),
AVAL_NEG_ID INT (1),
AVAL_COMENT NVARCHAR (250),
FOREIGN KEY (GRUPO_ID) REFERENCES GRUPO_APLIC(GRUPO_APLIC_ID),
FOREIGN KEY (USU_ID) REFERENCES USUARIO_APLIC(USU_APLIC_ID),
FOREIGN KEY (AVAL_POS_ID) REFERENCES AVALIACAO_DESC(AVAL_ID),
FOREIGN KEY (AVAL_NEG_ID) REFERENCES AVALIACAO_DESC(AVAL_ID)
) engine = 'InnoDB';

CREATE TABLE RELACAO_COMENT (
RELACAO_COMENT_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
TAR_TIPO CHAR NOT NULL,
COMENT_NUM INT (10) NOT NULL,
USU_ID INT (10) NOT NULL,
COMENT_DATE TIMESTAMP NOT NULL,
COMENT_DESC NVARCHAR (400) NOT NULL,
FOREIGN KEY (USU_ID) REFERENCES USUARIO_APLIC(USU_APLIC_ID)
) engine = 'InnoDB';

CREATE TABLE RELACAO_PERFIL (
RELACAO_PERFIL_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
UNI_ID INT (10) NOT NULL,
USU_ID INT (10) NOT NULL,
PERFIL_ID INT (10) NOT NULL,
FOREIGN KEY (UNI_ID) REFERENCES UNIDADE_APLIC(UNI_APLIC_ID),
FOREIGN KEY (USU_ID) REFERENCES USUARIO_APLIC(USU_APLIC_ID),
FOREIGN KEY (PERFIL_ID) REFERENCES PERFIL_DESC(PERFIL_ID)
) engine = 'InnoDB';

#############VIEWS#############

CREATE VIEW VIEW_ACESSO AS
SELECT USU_APLIC_ID, USU_EMAIL, USU_SENHA, USU_ULTIMO_ACESSO, USU_TENTATIVAS, USU_ATIVO FROM USUARIO_APLIC ;

CREATE VIEW VIEW_PONTUACAO AS
SELECT USUARIO_APLIC.USU_APLIC_ID AS USU_ID, SUM(RELACAO_NOTAS.PONTUACAO) AS SOMA_PONTOS , count(*) AS QTD_AVALIACOES, ROUND(AVG(RELACAO_NOTAS.PONTUACAO),2) AS MEDIA_PONTUACAO FROM USUARIO_APLIC INNER JOIN RELACAO_NOTAS ON USUARIO_APLIC.USU_APLIC_ID = RELACAO_NOTAS.USU_ID GROUP BY USU_ID;

INSERT INTO USUARIO_APLIC (USU_NOME,USU_EMAIL,USU_NASC,USU_TIPO,USU_REGISTRO,USU_CPF,USU_SENHA,USU_ATIVO,USU_CRIACAO,USU_ULTIMO_ACESSO,USU_TENTATIVAS)
VALUES ('MICHAEL','MAYCOW_77@HOTMAIL.COM','01/05/19 00:00:00','A','R106877','06919255502','123456','S','20/02/20 00:00:00','20/02/20 10:00:00','0');

CREATE TABLE INDICACOES (
IND_ID INT (10) PRIMARY KEY AUTO_INCREMENT,
ID_INDICADOR INT (10) NOT NULL,
ID_INDICADO INT (10) NOT NULL
);

INSERT INTO STATUS_TAREFA_DESC VALUES ('1','PLANEJAMENTO');
INSERT INTO STATUS_TAREFA_DESC VALUES ('2','EM TRABALHO');
INSERT INTO STATUS_TAREFA_DESC VALUES ('3','ENTREGUE');
INSERT INTO STATUS_TAREFA_DESC VALUES ('4','CANCELADO');

SELECT * FROM TAREFA_APLIC;

INSERT INTO TAREFA_APLIC (TAR_NOME,TAR_DESC,TAR_RESP_ID,TAR_USU_CRIADOR,TAR_FIM,TAR_STATUS) values ('AVALIACAO','EFETUAR TESTE','1','1','12/03/20 22:00:00','4');